name: CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }} - ${{ matrix.build_type }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Debug]

    steps:
      - uses: actions/checkout@v4

      - name: Cache deps and ccache
        uses: actions/cache@v4
        with:
          path: |
            cpp/_deps
            ~/.ccache
          key: ${{ runner.os }}-cmake-deps-${{ hashFiles('**/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-cmake-deps-

      - name: Setup ccache
        run: |
          if [ "${{ runner.os }}" == 'Linux' ]; then sudo apt-get update && sudo apt-get install -y ccache; fi
          if [ "${{ runner.os }}" == 'macOS' ]; then brew install ccache || true; fi
          export CCACHE_DIR="$HOME/.ccache"

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake cppcheck lcov

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install cmake cppcheck lcov

      - name: Configure
        run: cmake -S cpp -B cpp/build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Build
        run: cmake --build cpp/build --config ${{ matrix.build_type }} -- -j

      - name: Run tests
        run: |
          cd cpp/build && ctest --output-on-failure --parallel 2 || true
          # Also run the test binary directly to generate a JUnit XML for Codecov
          if [ -f ./cache_tests ]; then ./cache_tests --gtest_output=xml:junit.xml || true; fi

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Static analysis (cppcheck)
        run: |
          cppcheck --enable=warning,performance,portability --std=c++17 -I cpp/include cpp/src || true

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-log-${{ matrix.os }}
          path: cpp/build/Testing/Temporary/LastTest.log

      - name: Upload junit xml
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-${{ matrix.os }}
          path: cpp/build/junit.xml

  sanitizers:
    name: Sanitizers (ASan/UBSan)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake
      - name: Configure with sanitizers
        run: cmake -S cpp -B cpp/build-asan -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer" -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"
      - name: Build
        run: cmake --build cpp/build-asan -- -j
      - name: Run tests (sanitizers)
        run: |
          cd cpp/build-asan && ctest --output-on-failure || true
          if [ -f ./cache_tests ]; then ./cache_tests --gtest_output=xml:junit-asan.xml || true; fi
      - name: Upload test results to Codecov (sanitizers)
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          # The action will pick up junit-asan.xml in the working directory
      - name: Upload ASan logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: asan-log
          path: cpp/build-asan/Testing/Temporary/LastTest.log
      - name: Upload junit xml (sanitizers)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-asan
          path: cpp/build-asan/junit-asan.xml

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake lcov
      - name: Configure with coverage flags
        run: cmake -S cpp -B cpp/build-coverage -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage -O0" -DCMAKE_EXE_LINKER_FLAGS="--coverage"
      - name: Build
        run: cmake --build cpp/build-coverage -- -j
      - name: Run tests
        run: |
          cd cpp/build-coverage && ctest --output-on-failure || true
          if [ -f ./cache_tests ]; then ./cache_tests --gtest_output=xml:junit-coverage.xml || true; fi
      - name: Capture coverage
        run: |
          lcov --directory cpp/build-coverage --capture --output-file coverage.info || true
          lcov --remove coverage.info '/usr/*' '*/_deps/*' --output-file coverage.info || true
          genhtml coverage.info --output-directory coverage_html || true
      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ runner.os }}
          path: |
            coverage.info
            coverage_html

      - name: Upload test results to Codecov (coverage)
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: coverage.info
          flags: unittests
          name: codecov-${{ runner.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

      - name: Upload junit xml (coverage)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-coverage
          path: cpp/build-coverage/junit-coverage.xml

  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y build-essential cmake
      - name: Build perf_bench
        run: cmake -S cpp -B cpp/build -DCMAKE_BUILD_TYPE=Release && cmake --build cpp/build -- -j
      - name: Run benchmark harness (small)
        run: |
          chmod +x ./scripts/bench/run_bench.sh
          ./scripts/bench/run_bench.sh --ops 20000 --threads 2 --iters 3 --help >/dev/null || true
          ./scripts/bench/run_bench.sh --ops 20000 --threads 2 --iters 3 --dist zipf
      - name: Run rebalancer benchmark
        run: |
          cd cpp/build && ./rebalancer_bench || true
      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmarks-${{ runner.os }}-${{ github.run_id }}
          path: benchmarks/results

  format-and-lint:
    name: Formatting & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check formatting (clang-format)
        run: |
          sudo apt-get update && sudo apt-get install -y clang-format
          git ls-files '*.cpp' '*.h' | xargs -n1 -I{} clang-format -style=file -output-replacements-xml {} | grep -q '<replacement ' && (echo "Formatting issues found. Run 'clang-format -i <files>'" && exit 1) || echo "No formatting issues"
